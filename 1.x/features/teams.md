# Команды

[[toc]]

## Вступление

Если Вы установили Jetstream с помощью опции `team`, Ваше приложение будет построено для поддержки создания и управления командами:

```bash
laravel new project-name --jet --teams
```

:::warning Jetstream Команды

Каркас и опции команды Jetstream могут работать не для всех приложений. Если это не работает для Вашего варианта использования, смело создавайте приложение Jetstream, не основанное на команде, и самостоятельно добавляйте командные функции в свое приложение.
:::

Командные функции Jetstream позволяют каждому зарегистрированному пользователю создавать несколько команд и входить в них. По умолчанию каждый зарегистрированный пользователь будет входить в «Персональную» команду. Например, если пользователь с именем «Sally Jones» создает новую учетную запись, он будет назначен в команду с именем `Sally's Team`. После регистрации пользователь может переименовать эту команду или создать дополнительные команды.

![Скриншот команды Laravel](./../../assets/img/teams.png)

## Создание / удаление команды

Доступ к представлению создания команды осуществляется через раскрывающееся меню навигации пользователя в правом верхнем углу.

### Представления / Страницы

При использовании стека Livewire представление создания команды отображается с использованием шаблона Blade `resources/views/teams/create-team-form.blade.php`. При использовании стека Inertia это представление отображается с использованием шаблона `resources/js/Pages/Teams/CreateTeamForm.vue`.

### Действия

Логику создания и удаления команды можно настроить, изменив соответствующие классы действий в Вашем каталоге `app/Actions/Jetstream`. Эти действия включают `CreateTeam`, `UpdateTeamName` и `DeleteTeam`. Каждое из этих действий вызывается, когда соответствующая задача выполняется пользователем в пользовательском интерфейсе приложения. Вы можете изменять эти действия по мере необходимости в зависимости от потребностей Вашего приложения.

## Проверка пользовательских команд

Доступ к информации о командах пользователя можно получить с помощью методов, предоставляемых трейтом `Laravel\Jetstream\HasTeams`. Этот трейт автоматически применяется к модели Вашего приложения `App\Models\User` во время установки Jetstream. Этот трейт предоставляет множество полезных методов, которые позволяют Вам проверять команды пользователя:

```php
// Доступ к выбранной в данный момент команде пользователя...
$user->currentTeam : Laravel\Jetstream\Team

// Доступ ко всем командам (включая собственные команды), к которым принадлежит пользователь...
$user->allTeams() : Illuminate\Support\Collection

// Доступ ко всем командам, принадлежащим пользователю...
$user->ownedTeams : Illuminate\Database\Eloquent\Collection

// Доступ ко всем командам, к которым пользователь принадлежит, но не владелец...
$user->teams : Illuminate\Database\Eloquent\Collection

// Доступ к "личной" команде пользователя...
$user->personalTeam() : Laravel\Jetstream\Team

// Определение, владеет ли пользователь данной командой...
$user->ownsTeam($team) : bool

// Определение принадлежности пользователя к определенной команды...
$user->belongsToTeam($team) : bool

// Получение роли, назначенной пользователю в команде...
$user->teamRole($team) : \Laravel\Jetstream\Role

// Определение наличия у пользователя данной роли в данной команде...
$user->hasTeamRole($team, 'admin') : bool

// Доступ к массиву всех разрешений, имеющихся у пользователя для данной команде...
$user->teamPermissions($team) : array

// Определение, имеет ли пользователь данное разрешение рабочей команды...
$user->hasTeamPermission($team, 'server:create') : bool
```

### Текущая команда

У каждого пользователя в приложении Jetstream есть «текущая команда». Это команда, для которой пользователь активно просматривает ресурсы. Например, если Вы создаете приложение-календарь, Ваше приложение будет отображать предстоящие события календаря для текущей команды пользователя.

Вы можете получить доступ к текущей команде пользователя, используя отношение Eloquent `$user->currentTeam`. Эту команду можно использовать для анализа других Ваших запросов Eloquent:

```php
return App\Models\Calendar::where(
    'team_id', $request->user()->currentTeam->id
)->get();
```

Пользователь может переключить свою текущую команду через раскрывающееся меню профиля пользователя, доступное на панели навигации Jetstream.

![Скриншот смены команды](./../../assets/img/team-switcher.png)

### Объект команды

Объект команды, доступ к которому осуществляется через `$user->currentTeam` или через запросы Eloquent, предоставляет множество полезных методов для проверки атрибутов и взаимосвязей команды:

```php
// Доступ к владельцу команды...
$team->owner : \App\Models\User

// Получить всех пользователей команды, включая владельца...
$team->allUsers() : Illuminate\Database\Eloquent\Collection

// Получить всех пользователей команды, исключая владельца...
$team->users : Illuminate\Database\Eloquent\Collection

// Определение, является ли данный пользователь членом команды...
$team->hasUser($user) : bool

// Определение, есть ли в команде участник с данным адресом электронной почты...
$team->hasUserWithEmail($emailAddress) : bool

// Определение, является ли данный пользователь членом команды с данным разрешением...
$team->userHasPermission($user, $permission) : bool
```

## Управление участниками

Участники команды могут быть добавлены и удалены через представление Jetstream «Настройки команды». Логика серверной части, которая управляет этими действиями, может быть настроена путем изменения соответствующих действий, таких как класс `App\Actions\Jetstream\AddTeamMember`.

### Управление участниками Представления / Страницы

При использовании стека Livewire представление менеджера членов команды отображается с использованием блейд-шаблона `resources/views/teams/team-member-manager.blade.php`. При использовании стека Inertia это представление отображается с использованием шаблона `resources/js/Pages/Teams/TeamMemberManager.vue`. Как правило, эти шаблоны не требуют настройки.

### Управление участниками Действия

Логика добавления членов команды может быть настроена путем изменения класса действия `App\Actions\Jetstream\AddTeamMember`. Метод класса `add` вызывается с текущим аутентифицированным пользователем, экземпляром `Laravel\Jetstream\Team`, адресом электронной почты пользователя, добавляемого в команду, и ролью (если применимо) пользователя, добавляемого в команду.

Это действие отвечает за проверку того, что пользователь действительно может быть добавлен в команду, а затем за добавление пользователя в команду. Вы можете настроить это действие в соответствии с потребностями Вашего конкретного приложения.

### Роли / Разрешения

Каждому участнику команды, добавленному в команду, может быть назначена определенная роль, и каждой роли назначается набор разрешений. Разрешения ролей определяются в Вашем приложении `JetstreamServiceProvider` с помощью метода `Jetstream::role`. Этот метод принимает «слаг» для роли, удобное для пользователя имя роли, разрешения роли и описание роли. Эта информация будет использоваться для отображения роли в представлении управления членами команды:

```php
Jetstream::defaultApiTokenPermissions(['read']);

Jetstream::role('admin', 'Administrator', [
    'create',
    'read',
    'update',
    'delete',
])->description('Пользователи-администраторы могут выполнять любые действия.');

Jetstream::role('editor', 'Editor', [
    'read',
    'create',
    'update',
])->description('Пользователи-редакторы могут читать, создавать и обновлять.');
```

:::tip Поддержка API Команды

Когда Jetstream устанавливается с поддержкой команды, доступные разрешения API автоматически выводятся путем объединения всех уникальных разрешений, доступных для ролей. Следовательно, отдельный вызов метода `Jetstream::permissions` не требуется.
:::

### Авторизация

Конечно, Вам понадобится способ авторизации того, что входящие запросы, инициированные членом команды, могут действительно выполняться этим пользователем. Разрешения команды пользователя могут быть проверены с помощью метода `hasTeamPermission`, доступного через трейт `Laravel\Jetstream\HasTeams`. Нет необходимости проверять роль пользователя. Вам нужно только убедиться, что у пользователя есть определенные разрешения. Роли - это просто презентационная концепция, используемая для группировки детализированных разрешений. Обычно вызовы этого метода приложения выполняются в [политиках авторизации](https://laravel.com/docs/authorization):

```php
if ($request->user()->hasTeamPermission($team, 'read')) {
    // Роль пользователя включает разрешение на "чтение"...
}
```

#### Объединение разрешений команды с разрешениями API

При создании приложения Jetstream, которое обеспечивает как поддержку API, так и поддержку команды, Вы должны проверить разрешения команды **и** разрешения токена API входящего запроса в политиках авторизации вашего приложения. Это важно, потому что токен API может иметь теоретическую способность выполнять действие, в то время как пользователю фактически не предоставлено это действие через разрешения своей команды:

```php
/**
 * Определите, может ли пользователь просматривать.
 *
 * @param  \App\Models\User  $user
 * @param  \App\Models\Flight  $flight
 * @return bool
 */
public function view(User $user, Flight $flight)
{
    return $user->belongsToTeam($flight->team) &&
           $user->hasTeamPermission($flight->team, 'flight:view') &&
           $user->tokenCan('flight:view');
}
```
