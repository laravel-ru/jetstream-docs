# Безопасность

[[toc]]

## Вступление

Доступ к функциям безопасности Laravel Jetstream осуществляется через раскрывающееся меню навигации профиля пользователя в правом верхнем углу. Jetstream формирует представления и действия, которые позволяют пользователю обновлять свой пароль, включать / отключать двухфакторную аутентификацию и выходить из других сеансов браузера.

![Снимок экрана безопасности](./../../assets/img/security.png)

### Двухфакторная аутентификация

Laravel Jetstream автоматически поддерживает двухфакторную аутентификацию для всех приложений Jetstream. Когда пользователь включает двухфакторную аутентификацию для своей учетной записи, он должен сканировать данный QR-код с помощью бесплатного приложения для аутентификации, такого как Google Authenticator. Кроме того, они должны хранить перечисленные коды восстановления в безопасном менеджере паролей, таком как 1Password.

Если пользователь теряет доступ к своему мобильному устройству, представление входа в систему Jetstream позволит ему аутентифицироваться с использованием одного из своих кодов восстановления вместо временного токена, предоставленного приложением аутентификатора их мобильного устройства.

## Представления / Страницы

Как правило, представления и страницы для этих функций не требуют настройки, поскольку они уже завершены. Однако их расположение описано ниже.

### Обновление пароля

При использовании стека Livewire представление обновления пароля отображается с использованием шаблона Blade `resources/views/profile/update-password-form.blade.php`. При использовании стека Inertia это представление отображается с использованием шаблона `resources/js/Pages/Profile/UpdatePasswordForm.vue`.

### Двухфакторная аутентификация

При использовании стека Livewire вид управления двухфакторной аутентификацией отображается с использованием блейд-шаблона `resources/views/profile/two-factor-authentication-form.blade.php`. При использовании стека Inertia это представление отображается с использованием шаблона `resources/js/Pages/Profile/TwoFactorAuthenticationForm.vue`.

### Сеансы браузера

При использовании стека Livewire представление управления сеансом браузера отображается с использованием шаблона Blade `resources/views/profile/logout-other-browser-sessions-form.blade.php`. При использовании стека Inertia это представление отображается с использованием шаблона `resources/js/Pages/Profile/LogoutOtherBrowserSessionsForm.vue`.

Эта функция использует встроенное в Laravel промежуточное программное обеспечение `AuthenticateSession` для безопасного выхода из других сеансов браузера, которые аутентифицированы как текущий пользователь.

## Действия

Как типично для большинства функций Jetstream, логика, выполняемая для удовлетворения запросов, связанных с безопасностью, может быть найдена в классах действий в Вашем приложении. Однако настраивается только действие обновления пароля. Как правило, действия двухфакторной аутентификации и сеанса браузера должны оставаться инкапсулированными в Jetstream и не требовать настройки.

### Обновление пароля

Класс `App\Actions\Fortify\UpdateUserPassword` будет вызываться, когда пользователь обновит свой пароль. Это действие отвечает за проверку ввода и обновление пароля пользователя.

Это действие использует трейт `App\Actions\Fortify\PasswordValidationRules` для определения правил проверки, которые будут применяться к паролю. Настройка этого свойства будет одинаково влиять на правила проверки, применяемые к паролю, когда пользователь регистрируется, сбрасывает свой пароль или обновляет свой пароль.

### Правила проверки пароля

Как Вы могли заметить, трейт `App\Actions\Fortify\PasswordValidationRules` использует настраиваемый объект правила проверки `Laravel\Fortify\Rules\Password`. Этот объект позволяет Вам легко настроить требования к паролю для Вашего приложения. По умолчанию для правила требуется пароль длиной не менее 8 символов. Однако Вы можете использовать следующие методы для настройки требований к паролю:

```php
(new Password)->length(10)

// Требуется хотя бы один символ верхнего регистра...
(new Password)->requireUppercase()

// Требуется хотя бы один числовой символ...
(new Password)->requireNumeric()
```

## Подтверждение пароля

При создании приложения Вы можете иногда выполнять действия, требующие от пользователя подтверждения пароля перед выполнением действия. К счастью, в Jetstream есть встроенная функциональность, которая упрощает эту задачу.

### Livewire

Если Вы используете стек Livewire, Ваш компонент Livewire, содержащий действие с подтвержденным паролем, должен использовать трейт `Laravel\Jetstream\ConfirmsPasswords`. Затем Вы должны заключить действие, которое Вы хотите подтвердить, с помощью блейд-компонента `confirms-password`. Оболочка `confirms-password` должна содержать директиву `wire:then`, которая указывает, какое действие Livewire должно выполняться после подтверждения пароля пользователя. После того, как пользователь подтвердит свой пароль, ему не потребуется повторно вводить пароль до тех пор, пока не истечет количество секунд, определенное параметром конфигурации `auth.password_timeout`:

```html
<x-jet-confirms-password wire:then="enableAdminMode">
    <x-jet-button type="button" wire:loading.attr="disabled">
        {{ __('Enable') }}
    </x-jet-button>
</x-jet-confirms-password>
```

Затем в рамках Вашего действия Livewire, которое подтверждается, Вы должны вызвать метод `ensurePasswordIsConfirmed`. Делать это нужно в самом начале соответствующего метода действий:

```php
/**
 * Включить режим администрирования для пользователя.
 *
 * @return void
 */
public function enableAdminMode()
{
    $this->ensurePasswordIsConfirmed();

    // ...
}
```

### Inertia

Если Вы используете стек Inertia, Вам следует обернуть действие, которое Вы хотите подтвердить, с помощью компонента Vue `ConfirmsPassword`, предоставляемого Jetstream. Этот компонент-оболочка должен прослушивать событие `@confirmed`, чтобы запустить метод, который должен вызываться после подтверждения пароля пользователя. После того, как пользователь подтвердит свой пароль, ему не потребуется повторно вводить пароль до тех пор, пока не истечет количество секунд, определенное параметром конфигурации `auth.password_timeout`:

```js
import JetConfirmsPassword from './Jetstream/ConfirmsPassword'

export default {
    components: {
        JetConfirmsPassword,
        // ...
    },
}
```

Затем оберните компонент вокруг элемента, запускающего действие, которое необходимо подтвердить:

```html
<jet-confirms-password @confirmed="enableAdminMode">
    <jet-button type="button" :class="{ 'opacity-25': enabling }" :disabled="enabling">
        Enable
    </jet-button>
</jet-confirms-password>
```

Наконец, Вы должны убедиться, что маршруту, который выполняет подтвержденное действие, назначено промежуточное программное обеспечение `password.confirm`. Это промежуточное ПО включено в стандартную установку Laravel:

```php
Route::post('/admin-mode', function () {
    // ...
})->middleware(['password.confirm']);
```

### Настройка способа подтверждения паролей

Иногда Вам может потребоваться настроить способ проверки пароля пользователя во время подтверждения. Для этого Вы можете использовать метод `Fortify::confirmPasswordsUsing`. Этот метод принимает Замыкание, которое получает аутентифицированный пользовательский экземпляр и входное значение запроса `password`. Замыкание должно вернуть `true`, если пароль действителен для данного пользователя. Обычно этот метод следует вызывать из метода `boot` Вашего `JetstreamServiceProvider`:

```php
use Illuminate\Support\Facades\Hash;
use Laravel\Fortify\Fortify;

Fortify::confirmPasswordsUsing(function ($user, string $password) {
    return Hash::check($password, $user->password);
});
```
