# API

[[toc]]

## Введение

Jetstream включает встроенную интеграцию с [Laravel Sanctum](https://getlaravel.ru/docs/sanctum). Laravel Sanctum предоставляет легкую систему аутентификации для SPA (одностраничных приложений), мобильных приложений и простых API на основе токенов. Sanctum позволяет каждому пользователю Вашего приложения создавать несколько токенов API для своей учетной записи. Этим токенам могут быть предоставлены возможности / разрешения, которые определяют, какие действия токенам разрешено выполнять.

![Скриншот Laravel Jetstream API](./../../assets/img/api.png)

По умолчанию к панели создания токенов API можно получить доступ, используя ссылку «API» в раскрывающемся меню профиля пользователя в правом верхнем углу. На этом экране пользователи могут создавать токены Sanctum API с различными разрешениями.

:::tip Документация Sanctum

Для получения дополнительной информации о Sanctum и о том, как отправлять запросы к API с аутентификацией Sanctum, обратитесь к официальной [документации Sanctum](https://getlaravel.ru/docs/sanctum).
:::

## Включение поддержки API

Если Ваше приложение будет предлагать API, который может использоваться третьими сторонами, Вы должны включить функцию API Jetstream. Для этого Вы должны раскомментировать соответствующую запись в опции конфигурации `features` конфигурационного файла Вашего приложения `config/jetstream.php`:

```php
'features' => [
    Features::profilePhotos(),
    Features::api(),
    Features::teams(),
],
```

## Определение разрешений

Разрешения, доступные для токенов API, определяются с помощью метода `Jetstream::permissions` в классе `App\Providers\JetstreamServiceProvider` Вашего приложения. Разрешения определяются как простые строки. Как только они будут определены, они могут быть назначены токену API:

```php
Jetstream::defaultApiTokenPermissions(['read']);

Jetstream::permissions([
    'post:create',
    'post:read',
    'post:update',
    'post:delete',
]);
```

Метод `defaultApiTokenPermissions` в приведенном выше примере может использоваться для указания, какие разрешения должны быть выбраны по умолчанию при создании нового токена API. Конечно, пользователь может снять отметку с разрешения по умолчанию перед созданием токена.

## Авторизация входящих запросов

Каждый запрос, сделанный к Вашему приложению Jetstream, даже к аутентифицированным маршрутам в Вашем файле `routes/web.php`, будет связан с объектом токена Sanctum. Вы можете определить, имеет ли связанный токен данное разрешение, используя метод `tokenCan`, предоставляемый трейтом `Laravel\Sanctum\HasApiTokens`.

Этот трейт `HasApiTokens` автоматически применяется к модели Вашего приложения `App\Models\User` во время установки Jetstream. Обычно Вы вызываете метод `tokenCan` в контроллерах Вашего приложения, компонентах Livewire или [политиках авторизации](https://getlaravel.ru/docs/authorization#creating-policies):

```php
return $request->user()->id === $post->user_id &&
       $request->user()->tokenCan('post:update')
```

### Запросы, инициированные пользовательским интерфейсом

Когда пользователь делает запрос к маршруту в Вашем файле `routes/web.php`, запрос обычно аутентифицируется Sanctum через аутентифицированную защиту на основе cookie сеанса. В большинстве приложений Laravel это `web` защита.

Когда пользователь делает первичный запрос через пользовательский интерфейс приложения, метод `tokenCan` всегда будет возвращать `true`. Помните, это не обязательно означает, что Ваше приложение должно позволять пользователю выполнять действие. Как правило, Ваши политики определяют, предоставлено ли токену разрешение на выполнение возможностей, **а также проверяют, разрешено ли самому экземпляру пользователя выполнять действие**.

Например, в случае обновления сообщения в блоге это может означать проверку того, что токен авторизован для обновления сообщений **и** что сообщение принадлежит пользователю:

```php
return $request->user()->id === $post->user_id &&
       $request->user()->tokenCan('post:update')
```

Сначала может показаться странным разрешение вызова метода `tokenCan` и всегда возвращать `true` для запросов, инициированных пользовательским интерфейсом первой стороны; однако удобно всегда предполагать, что токен API доступен и может быть проверен с помощью метода `tokenCan`. Это означает, что Вы всегда можете вызвать метод `tokenCan` в политиках авторизации Вашего приложения, не беспокоясь о том, был ли запрос инициирован из пользовательского интерфейса Вашего приложения или был инициирован одним из сторонних потребителей Вашего API.
